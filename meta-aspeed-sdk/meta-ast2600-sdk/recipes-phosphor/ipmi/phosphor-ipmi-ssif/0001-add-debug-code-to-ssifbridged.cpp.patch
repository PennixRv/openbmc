From c00a51485afaba3ebed1b9116fed2989b4d178fb Mon Sep 17 00:00:00 2001
From: pengfu <peng.fu@rivai.ai>
Date: Fri, 7 Jun 2024 08:00:57 +0000
Subject: [PATCH] add debug-code to ssifbridged.cpp

---
 ssifbridged.cpp | 72 ++++++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 71 insertions(+), 1 deletion(-)

diff --git a/ssifbridged.cpp b/ssifbridged.cpp
index 4ab1197..e57cdd7 100644
--- a/ssifbridged.cpp
+++ b/ssifbridged.cpp
@@ -118,6 +118,10 @@ SsifChannel::SsifChannel(std::shared_ptr<boost::asio::io_context>& io,
     }
     else
     {
+        std::string msgToLog = "Opened SSIF driver with flags O_RDWR."
+                               " FILENAME=" +
+                               devName;
+        log<level::INFO>(msgToLog.c_str());
         dev = std::make_unique<boost::asio::posix::stream_descriptor>(*io, fd);
     }
 
@@ -127,6 +131,11 @@ SsifChannel::SsifChannel(std::shared_ptr<boost::asio::io_context>& io,
     std::shared_ptr<sdbusplus::asio::dbus_interface> iface =
         server->add_interface(ssifObj, ssifBus);
     iface->initialize();
+    std::string msgToLog = "SSIFChannel initialized successfully."
+                           " device=" + devName +
+                           " verbose=" + std::to_string(verbose) +
+                           " numberOfReqNotRsp=" + std::to_string(numberOfReqNotRsp);
+    log<level::INFO>(msgToLog.c_str());
 }
 
 void SsifChannel::channelAbort(const char* msg,
@@ -140,15 +149,35 @@ void SsifChannel::channelAbort(const char* msg,
 
 void SsifChannel::async_read()
 {
+    std::string msgToLog = "Starting async_read...";
+    log<level::DEBUG>(msgToLog.c_str());
     boost::asio::async_read(*dev,
                             boost::asio::buffer(xferBuffer, xferBuffer.size()),
                             boost::asio::transfer_at_least(2),
                             [this](const boost::system::error_code& ec,
-                                   size_t rlen) { processMessage(ec, rlen); });
+                                   size_t rlen) { 
+                                std::string msgToLog = "async_read callback triggered"
+                                                       " ec=" + ec.message() +
+                                                       " rlen=" + std::to_string(rlen);
+                                log<level::DEBUG>(msgToLog.c_str());
+                                
+                                // Print read data in hex
+                                std::ostringstream oss;
+                                oss << "Read data: ";
+                                for (size_t i = 0; i < rlen; ++i)
+                                {
+                                    oss << std::hex << std::setw(2) << std::setfill('0') << static_cast<int>(xferBuffer[i]) << " ";
+                                }
+                                log<level::ERR>(oss.str().c_str());
+
+                                processMessage(ec, rlen); 
+                            });
 }
 
 int SsifChannel::showNumOfReqNotRsp()
 {
+    std::string msgToLog = "showNumOfReqNotRsp called. numberOfReqNotRsp=" + std::to_string(numberOfReqNotRsp);
+    log<level::DEBUG>(msgToLog.c_str());
     return numberOfReqNotRsp;
 }
 
@@ -193,6 +222,10 @@ void rspTimerHandler()
             " cmd=" + std::to_string(rsp[ssifchannel->sizeofLenField + 1]) +
             " cc=" + std::to_string(ccResponseNotAvailable);
         log<level::ERR>(msgToLog.c_str());
+    } else {
+        msgToLog = "Successfully sent ssif respond message:"
+                   " size=" + std::to_string(wlen);
+        log<level::INFO>(msgToLog.c_str());
     }
 }
 
@@ -201,12 +234,22 @@ void initTimer()
     if (!rspTimer)
     {
         rspTimer = std::make_unique<sdbusplus::Timer>(rspTimerHandler);
+        std::string msgToLog = "Response timer initialized.";
+        log<level::INFO>(msgToLog.c_str());
+    } else {
+        std::string msgToLog = "Response timer already initialized.";
+        log<level::DEBUG>(msgToLog.c_str());
     }
 }
 
 void SsifChannel::processMessage(const boost::system::error_code& ecRd,
                                  size_t rlen)
 {
+    std::string msgToLog = "processMessage called"
+                           " ecRd=" + ecRd.message() +
+                           " rlen=" + std::to_string(rlen);
+    log<level::DEBUG>(msgToLog.c_str());
+
     if (ecRd || rlen < 2)
     {
         channelAbort("Failed to read req msg", ecRd);
@@ -342,6 +385,16 @@ void SsifChannel::processMessage(const boost::system::error_code& ecRd,
                 " numberOfReqNotRsp=" + std::to_string(numberOfReqNotRsp);
             log<level::INFO>(msgToLog.c_str());
         }
+        
+        // Print write data in hex
+        std::ostringstream oss;
+        oss << "Write data: ";
+        for (size_t i = 0; i < rsp.size(); ++i)
+        {
+            oss << std::hex << std::setw(2) << std::setfill('0') << static_cast<int>(rsp[i]) << " ";
+        }
+        log<level::ERR>(oss.str().c_str());
+
         boost::system::error_code ecWr;
         size_t wlen = boost::asio::write(*dev, boost::asio::buffer(rsp), ecWr);
         if (ecWr || wlen != rsp.size())
@@ -354,6 +407,10 @@ void SsifChannel::processMessage(const boost::system::error_code& ecRd,
                 " lun=" + std::to_string(lun) + " cmd=" + std::to_string(cmd) +
                 " cc=" + std::to_string(cc);
             log<level::ERR>(msgToLog.c_str());
+        } else {
+            std::string msgToLog = "Successfully sent ssif respond message:"
+                                   " size=" + std::to_string(wlen);
+            log<level::INFO>(msgToLog.c_str());
         }
         rspTimer->stop();
     },
@@ -372,11 +429,17 @@ int main(int argc, char* argv[])
     app.add_option("-v,--verbose", verbose, "print more verbose output");
     CLI11_PARSE(app, argc, argv);
 
+    std::string msgToLog = "Program started. Parsing arguments.";
+    log<level::INFO>(msgToLog.c_str());
+
     // Connect to system bus
     auto io = std::make_shared<boost::asio::io_context>();
     sd_bus* dbus;
     sd_bus_default_system(&dbus);
 
+    msgToLog = "Connected to system bus.";
+    log<level::INFO>(msgToLog.c_str());
+
     /* This might be a sdbusplus::Timer bug, without timer t2, rspTimer
      * will not work
      */
@@ -389,11 +452,18 @@ int main(int argc, char* argv[])
                                            numberOfReqNotRsp);
     if (!ssifchannel->initOK())
     {
+        msgToLog = "SSIF channel initialization failed.";
+        log<level::ERR>(msgToLog.c_str());
         return EXIT_FAILURE;
     }
     initTimer();
     sdbusplus::asio::sd_event_wrapper sdEvents(*io);
+    msgToLog = "Starting io_context run loop.";
+    log<level::INFO>(msgToLog.c_str());
     io->run();
 
+    msgToLog = "Program exiting.";
+    log<level::INFO>(msgToLog.c_str());
+
     return 0;
 }
